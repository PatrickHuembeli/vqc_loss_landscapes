---

title: Title

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: Ex1_Train_Reuploading_Circuit_Pytorch.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">vqc_loss_landscapes.torchcirq</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">vqc_loss_landscapes.data_helper</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">vqc_loss_landscapes.complex</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">qutip.qip.circuit</span> <span class="k">as</span> <span class="nn">QCirc</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span> <span class="k">as</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">load_circle_data</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">np_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np_file</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_loss</span><span class="p">(</span><span class="n">circ</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">measurements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
        <span class="c1"># print(&quot;test loss: &quot;, i)</span>
        <span class="c1"># i+=1</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">matmul</span><span class="p">(</span><span class="n">circ</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">init</span><span class="p">)</span>
        <span class="n">out1_copy</span> <span class="o">=</span> <span class="n">out1</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out2</span> <span class="o">=</span> <span class="n">matmul</span><span class="p">(</span><span class="n">measurements</span><span class="p">,</span> <span class="n">out1</span><span class="p">)</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">inner_prod</span><span class="p">(</span><span class="n">out1_copy</span><span class="p">,</span> <span class="n">out2</span><span class="p">)</span> <span class="c1"># this is already &lt;Psi|0&gt;&lt;0|Psi&gt;</span>
        <span class="c1"># print(out1[0])</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">out1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">predicted_labels</span><span class="p">(</span><span class="n">output_fidelity</span><span class="p">):</span>
    <span class="n">output_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">output_fidelity</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">prediction</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">measurements</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For prediction of model measure in both directions&quot;&quot;&quot;</span>
    <span class="n">output_fidelity</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))):</span>
        <span class="n">fidelities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">matmul</span><span class="p">(</span><span class="n">circ</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">init</span><span class="p">)</span>
        <span class="n">out1_copy</span> <span class="o">=</span> <span class="n">out1</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out2</span> <span class="o">=</span> <span class="n">matmul</span><span class="p">(</span><span class="n">measurements</span><span class="p">,</span> <span class="n">out1</span><span class="p">)</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">inner_prod</span><span class="p">(</span><span class="n">out1_copy</span><span class="p">,</span> <span class="n">out2</span><span class="p">)</span>
        <span class="n">fidelities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
        <span class="k">del</span> <span class="n">out1</span>
        <span class="n">output_fidelity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fidelities</span><span class="p">)</span>
    <span class="c1">#predicted = predicted_labels(output_fidelity)</span>
    <span class="k">return</span> <span class="n">output_fidelity</span>

<span class="k">def</span> <span class="nf">get_fidelity</span><span class="p">():</span>
    <span class="n">fidl</span><span class="o">=</span> <span class="n">prediction</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">X_map</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">measurements</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">measures</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fidl</span><span class="p">)</span>
    <span class="n">fidelity</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">fidelity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">fidelity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fidelity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fidelity</span>


<span class="k">def</span> <span class="nf">plot_prediction_map</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="n">fidelity</span> <span class="o">=</span> <span class="n">get_fidelity</span><span class="p">()</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">fidelity</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">grid_resolution</span><span class="p">,</span> <span class="n">grid_resolution</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">cont</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span><span class="n">Y_grid</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cont</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
<span class="c1">#============================================================================</span>
<span class="c1"># Mapping Parameters</span>
<span class="c1"># ==========================================================================</span>
<span class="n">grid_resolution</span> <span class="o">=</span> <span class="mi">21</span>

<span class="n">x_path</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">grid_resolution</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">y_path</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">grid_resolution</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">X_grid</span><span class="p">,</span> <span class="n">Y_grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_path</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">y_path</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

<span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_path</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_path</span><span class="p">)):</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_path</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">X_map</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>

<span class="n">width</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">layers</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">train_samples</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">test_samples</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># ==========================================================================</span>
<span class="c1"># Data Generating</span>
<span class="c1"># ==========================================================================</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">generate_circle_data</span><span class="p">(</span><span class="n">train_samples</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">train_samples</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:]</span> <span class="c1"># add extra dim x_3 = 0</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">generate_circle_data</span><span class="p">(</span><span class="n">test_samples</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">test_samples</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">X_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:]</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># =================================================================================</span>
<span class="c1"># Main Training</span>
<span class="c1"># =================================================================================</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start training width</span><span class="si">{}</span><span class="s2"> layers</span><span class="si">{}</span><span class="s2"> epochs</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">epochs</span><span class="p">))</span>
<span class="n">init</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># Define initial state</span>

<span class="n">init</span> <span class="o">=</span> <span class="n">make_complex</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">layers</span><span class="p">,</span> <span class="n">width</span> <span class="p">,</span><span class="mi">2</span> <span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">([</span><span class="n">params</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model_Z_measure</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">,</span> <span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="c1"># circ = model.build_circuit(params, x=torch.randn((3)))</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span>

<span class="n">circ</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_circuit</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;circuit built&quot;</span><span class="p">)</span>
<span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span> <span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">progress</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
    <span class="n">plot_prediction_map</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="c1"># take random sample of X and y (bc it is faster)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">test_loss</span><span class="p">(</span><span class="n">circ</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">measurements</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">measures</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">ev</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">find_heigenvalues</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hessian eigenvalues&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">batch_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">Xbatch</span><span class="p">,</span> <span class="n">ybatch</span> <span class="ow">in</span> <span class="n">iterate_minibatches</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">y_train</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">batch_idx</span><span class="o">%</span><span class="k">10</span> == 0:
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;epoch: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;batch: &quot;</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">)</span>
        <span class="n">batch_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">test_loss</span><span class="p">(</span><span class="n">circ</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">Xbatch</span><span class="p">,</span> <span class="n">ybatch</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">measurements</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">measures</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calc Hessian&quot;</span><span class="p">)</span>

    <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">([</span><span class="n">params</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">progress</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span><span class="s1">&#39;loss: </span><span class="si">{:3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>start training width2 layers4 epochs100
circuit built
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-63-c60324ee5190&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     23</span> <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> progress<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     24</span>     index <span class="ansi-blue-fg">=</span> torch<span class="ansi-blue-fg">.</span>randperm<span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>X_train<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 25</span><span class="ansi-red-fg">     </span>plot_prediction_map<span class="ansi-blue-fg">(</span>i<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     26</span>     X <span class="ansi-blue-fg">=</span> X_train<span class="ansi-blue-fg">[</span>index<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span><span class="ansi-cyan-fg">10</span><span class="ansi-blue-fg">]</span> <span class="ansi-red-fg"># take random sample of X and y (bc it is faster)</span>
<span class="ansi-green-intense-fg ansi-bold">     27</span>     y <span class="ansi-blue-fg">=</span> y_train<span class="ansi-blue-fg">[</span>index<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span><span class="ansi-cyan-fg">10</span><span class="ansi-blue-fg">]</span>

<span class="ansi-green-fg">&lt;ipython-input-61-10e6dbf0283e&gt;</span> in <span class="ansi-cyan-fg">plot_prediction_map</span><span class="ansi-blue-fg">(epoch)</span>
<span class="ansi-green-intense-fg ansi-bold">     49</span> 
<span class="ansi-green-intense-fg ansi-bold">     50</span> <span class="ansi-green-fg">def</span> plot_prediction_map<span class="ansi-blue-fg">(</span>epoch<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 51</span><span class="ansi-red-fg">     </span>fidelity <span class="ansi-blue-fg">=</span> get_fidelity<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     52</span>     Z <span class="ansi-blue-fg">=</span> fidelity<span class="ansi-blue-fg">.</span>reshape<span class="ansi-blue-fg">(</span>grid_resolution<span class="ansi-blue-fg">,</span> grid_resolution<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     53</span>     fig <span class="ansi-blue-fg">=</span> plt<span class="ansi-blue-fg">.</span>figure<span class="ansi-blue-fg">(</span>figsize<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">10</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">10</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-61-10e6dbf0283e&gt;</span> in <span class="ansi-cyan-fg">get_fidelity</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-intense-fg ansi-bold">     39</span> 
<span class="ansi-green-intense-fg ansi-bold">     40</span> <span class="ansi-green-fg">def</span> get_fidelity<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 41</span><span class="ansi-red-fg">     </span>fidl<span class="ansi-blue-fg">=</span> prediction<span class="ansi-blue-fg">(</span>params<span class="ansi-blue-fg">,</span> x<span class="ansi-blue-fg">=</span>X_map<span class="ansi-blue-fg">,</span> y<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> measurements <span class="ansi-blue-fg">=</span> model<span class="ansi-blue-fg">.</span>measures<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">=</span>device<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     42</span>     c <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>array<span class="ansi-blue-fg">(</span>fidl<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     43</span>     fidelity <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>

<span class="ansi-green-fg">&lt;ipython-input-61-10e6dbf0283e&gt;</span> in <span class="ansi-cyan-fg">prediction</span><span class="ansi-blue-fg">(params, x, y, measurements, device)</span>
<span class="ansi-green-intense-fg ansi-bold">     28</span>     <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> tqdm<span class="ansi-blue-fg">(</span>range<span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     29</span>         fidelities <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg">---&gt; 30</span><span class="ansi-red-fg">         </span>out1 <span class="ansi-blue-fg">=</span> matmul<span class="ansi-blue-fg">(</span>circ<span class="ansi-blue-fg">(</span>params<span class="ansi-blue-fg">,</span> x<span class="ansi-blue-fg">=</span>x<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">=</span>device<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> init<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     31</span>         out1_copy <span class="ansi-blue-fg">=</span> out1<span class="ansi-blue-fg">.</span>clone<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>detach<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>requires_grad_<span class="ansi-blue-fg">(</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     32</span>         out2 <span class="ansi-blue-fg">=</span> matmul<span class="ansi-blue-fg">(</span>measurements<span class="ansi-blue-fg">,</span> out1<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/Dropbox/vqc_loss_landscapes/vqc_loss_landscapes/torchcirq.py</span> in <span class="ansi-cyan-fg">build_circuit</span><span class="ansi-blue-fg">(self, params, x, device)</span>
<span class="ansi-green-intense-fg ansi-bold">    286</span> 
<span class="ansi-green-intense-fg ansi-bold">    287</span>     <span class="ansi-green-fg">def</span> build_circuit<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> params<span class="ansi-blue-fg">,</span> x<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;cpu&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 288</span><span class="ansi-red-fg">         </span>circuit <span class="ansi-blue-fg">=</span> matmul<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>CZ_layer<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">=</span>device<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>Rot_layer<span class="ansi-blue-fg">(</span>params<span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span> x<span class="ansi-blue-fg">=</span>x<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">=</span>device<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    289</span>         <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>layers<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    290</span>             circuit <span class="ansi-blue-fg">=</span> matmul<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>Rot_layer<span class="ansi-blue-fg">(</span>params<span class="ansi-blue-fg">,</span> i<span class="ansi-blue-fg">,</span> x<span class="ansi-blue-fg">=</span>x<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">=</span>device<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> circuit<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/Dropbox/vqc_loss_landscapes/vqc_loss_landscapes/torchcirq.py</span> in <span class="ansi-cyan-fg">Rot_layer</span><span class="ansi-blue-fg">(self, params, layer, x, device)</span>
<span class="ansi-green-intense-fg ansi-bold">    271</span>             angles <span class="ansi-blue-fg">=</span> par<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">+</span> par<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">*</span>x<span class="ansi-blue-fg">.</span>float<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    272</span>             <span class="ansi-green-fg">if</span> Rot_Matrix <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 273</span><span class="ansi-red-fg">                 </span>Rot_Matrix <span class="ansi-blue-fg">=</span> kronecker_prod<span class="ansi-blue-fg">(</span> R3<span class="ansi-blue-fg">(</span>angles<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> Rot_Matrix<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    274</span>             <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    275</span>                 Rot_Matrix <span class="ansi-blue-fg">=</span> R3<span class="ansi-blue-fg">(</span>angles<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/Dropbox/vqc_loss_landscapes/vqc_loss_landscapes/torchcirq.py</span> in <span class="ansi-cyan-fg">R3</span><span class="ansi-blue-fg">(angles)</span>
<span class="ansi-green-intense-fg ansi-bold">     52</span>         phi <span class="ansi-blue-fg">=</span> list<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> theta <span class="ansi-blue-fg">=</span> list<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> omega <span class="ansi-blue-fg">=</span> list<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">     53</span>     &#34;&#34;&#34;
<span class="ansi-green-fg">---&gt; 54</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> matmul<span class="ansi-blue-fg">(</span>matmul<span class="ansi-blue-fg">(</span>R1<span class="ansi-blue-fg">(</span>angles<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> Z<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> R1<span class="ansi-blue-fg">(</span>angles<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> Y<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> R1<span class="ansi-blue-fg">(</span>angles<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> Z<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     55</span> 
<span class="ansi-green-intense-fg ansi-bold">     56</span> <span class="ansi-green-fg">def</span> CZ<span class="ansi-blue-fg">(</span>width<span class="ansi-blue-fg">,</span> c<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> t<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/Dropbox/vqc_loss_landscapes/vqc_loss_landscapes/torchcirq.py</span> in <span class="ansi-cyan-fg">R1</span><span class="ansi-blue-fg">(angle, matrix)</span>
<span class="ansi-green-intense-fg ansi-bold">     42</span>         rotation axis defined by <span class="ansi-cyan-fg">2</span>x2 matrix
<span class="ansi-green-intense-fg ansi-bold">     43</span>     &#34;&#34;&#34;
<span class="ansi-green-fg">---&gt; 44</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> torch<span class="ansi-blue-fg">.</span>cos<span class="ansi-blue-fg">(</span>angle<span class="ansi-blue-fg">/</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">*</span>unity<span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">+</span> torch<span class="ansi-blue-fg">.</span>sin<span class="ansi-blue-fg">(</span>angle<span class="ansi-blue-fg">/</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">*</span>make_complex<span class="ansi-blue-fg">(</span>matrix<span class="ansi-blue-fg">*</span><span class="ansi-cyan-fg">1j</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     45</span> 
<span class="ansi-green-intense-fg ansi-bold">     46</span> <span class="ansi-green-fg">def</span> R3<span class="ansi-blue-fg">(</span>angles<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

