---

title: Compare Hessian, metric tensor and vanilla SGD

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: Ex3_Hessian_vs_metric_tensor.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">metric_tensor</span><span class="p">,</span> <span class="n">recompute_tensor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">compute_grad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">cost_fidelity</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">circuit</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">metric_tensor</span> <span class="o">=</span> <span class="n">metric_tensor</span> <span class="o">+</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">metric_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x_out</span> <span class="o">=</span> <span class="n">apply_grad</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">metric_tensor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_out</span><span class="p">,</span> <span class="n">metric_tensor</span>


<span class="k">def</span> <span class="nf">apply_grad</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">metric_tensor</span><span class="p">):</span>
    <span class="n">grad_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_flatten</span><span class="p">(</span><span class="n">grad</span><span class="p">)))</span>
    <span class="n">x_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">x_new_flat</span> <span class="o">=</span> <span class="n">x_flat</span> <span class="o">-</span> <span class="n">stepsize</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">metric_tensor</span><span class="p">,</span> <span class="n">grad_flat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unflatten</span><span class="p">(</span><span class="n">x_new_flat</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Setup_For_Training</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">rho_target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_target</span> <span class="o">=</span> <span class="n">rho_target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gates</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_wires</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)]</span>
        
    <span class="k">def</span> <span class="nf">parametric_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="c1"># There are 3 params per gate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gates</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">wire</span><span class="p">][</span><span class="n">i</span><span class="p">](</span><span class="n">params</span><span class="p">[</span><span class="n">wire</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">wire</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">entangler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">%</span><span class="k">2</span>==0:
            <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">qml</span><span class="o">.</span><span class="n">CZ</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">wire</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">wire</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">%</span><span class="k">2</span>==1:
            <span class="k">for</span> <span class="n">wire</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">qml</span><span class="o">.</span><span class="n">CZ</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">wire</span><span class="p">,</span> <span class="p">(</span><span class="n">wire</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="k">self</span>.width])
        
    <span class="k">def</span> <span class="nf">generate_gates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;order is either random or a list of gates, where each gate defines the gates in a layer&quot;</span>
        <span class="s2">&quot;Therefore if the first element is e.g. Rx, the whole layer will be Rx&quot;</span>
        <span class="n">gate_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">qml</span><span class="o">.</span><span class="n">RZ</span><span class="p">,</span> <span class="n">qml</span><span class="o">.</span><span class="n">RY</span><span class="p">,</span> <span class="n">qml</span><span class="o">.</span><span class="n">RZ</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gates</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gate_list</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==gate list does not have right dimension, must contain as&quot;</span><span class="p">,</span> 
                  <span class="s2">&quot;many gates as there are layers in the model, layers=</span><span class="si">{}</span><span class="s2">==&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gates</span>

    <span class="k">def</span> <span class="nf">cost_fidelity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">circuit</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">qcircuit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parametric_layer</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entangler</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qml</span><span class="o">.</span><span class="n">expval</span><span class="p">(</span><span class="n">qml</span><span class="o">.</span><span class="n">Hermitian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho_target</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_wires</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">Hessian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">circuit</span><span class="p">):</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">hess_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">])</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">hess_dim</span><span class="p">,))</span>
        <span class="n">Hessian_Matr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">hess_dim</span><span class="p">,</span> <span class="n">hess_dim</span><span class="p">))</span>
        <span class="c1">#print(&quot;Hessian Dimension: {}, {}&quot;.format(shape[0], shape[0]))</span>
        <span class="n">measure_normal</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">gradient</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hess_dim</span><span class="p">):</span>
            <span class="n">eps_plus</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">eps_plus</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eps</span>
            <span class="n">exp_value_plus</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">eps_plus</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

            <span class="n">eps_minus</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">eps_minus</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eps</span>
            <span class="n">exp_value_minus</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">eps_minus</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

            <span class="n">gradient_result</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">exp_value_plus</span> <span class="o">-</span> <span class="n">exp_value_minus</span><span class="p">)</span>
            <span class="n">gradient</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gradient_result</span><span class="p">)</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>    

        <span class="c1">#progress = tqdm(range(hess_dim))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hess_dim</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hess_dim</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">&lt;=</span><span class="n">k</span><span class="p">:</span>
                    <span class="n">eps_pp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">eps_pp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eps</span>
                    <span class="n">eps_pp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eps</span>

                    <span class="n">eps_pm</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">eps_pm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eps</span>
                    <span class="n">eps_pm</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eps</span>

                    <span class="n">eps_mp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">eps_mp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eps</span>
                    <span class="n">eps_mp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eps</span>

                    <span class="n">eps_mm</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">eps_mm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eps</span>
                    <span class="n">eps_mm</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eps</span>

                    <span class="n">measure_pp</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">eps_pp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">measure_pm</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">eps_pm</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">measure_mp</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">eps_mp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">measure_mm</span> <span class="o">=</span> <span class="n">circuit</span><span class="p">(</span><span class="n">eps_mm</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                    <span class="c1">#result_eps_pp = torch.tensor([exp_value_pp])</span>
                    <span class="c1">#print(measure_mm, measure_mp)</span>
                    <span class="n">hessian_result</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">measure_pp</span> <span class="o">+</span> <span class="n">measure_mm</span> <span class="o">-</span> <span class="n">measure_mp</span> <span class="o">-</span> <span class="n">measure_pm</span><span class="p">)</span>
                    <span class="c1"># for loss = (1-f)**2, hessian is 2f&#39;f&#39; + 2(f-1)f&#39;&#39;</span>
                    <span class="c1">#Hessian_Matr[k][l] = 2*gradient[k]*gradient[l] + 2*(measure_normal - 1)*hessian_result</span>

                    <span class="c1"># for loss = (1-f), hessian is -f&#39;&#39;</span>
                    <span class="n">Hessian_Matr</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">hessian_result</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hess_dim</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hess_dim</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">&gt;</span><span class="n">k</span><span class="p">:</span>
                    <span class="n">Hessian_Matr</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hessian_Matr</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Hessian_Matr</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">qcircuit</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;bound method Setup_For_Training.qcircuit of &lt;__main__.Setup_For_Training object at 0x7fc4051abd50&gt;&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># must be odd</span>
<span class="n">layers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">shots</span> <span class="o">=</span> <span class="mi">8192</span>

<span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">width</span><span class="p">,))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">width</span><span class="p">))</span>
<span class="n">rho_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">target</span> <span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="n">qml</span><span class="o">.</span><span class="n">RY</span><span class="p">,</span> <span class="n">qml</span><span class="o">.</span><span class="n">RZ</span><span class="p">]</span>
<span class="n">gates_sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">4</span>

<span class="n">init_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">width</span> <span class="o">*</span> <span class="n">layers</span> <span class="o">*</span><span class="mi">3</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Setup_For_Training</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">rho_target</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">generate_gates</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">gates</span>

<span class="n">theta</span> <span class="o">=</span> <span class="n">init_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">dev</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;qiskit.aer&quot;</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="n">shots</span><span class="p">)</span>

<span class="n">circuit</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">QNode</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">qcircuit</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>

<span class="n">circuit</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">_circuit</span>
<span class="n">a</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AttributeError</span>                            Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-7-e3539a2977fa&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     20</span> dev <span class="ansi-blue-fg">=</span> qml<span class="ansi-blue-fg">.</span>device<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;qiskit.aer&#34;</span><span class="ansi-blue-fg">,</span> wires<span class="ansi-blue-fg">=</span>width<span class="ansi-blue-fg">,</span> shots<span class="ansi-blue-fg">=</span>shots<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     21</span> 
<span class="ansi-green-fg">---&gt; 22</span><span class="ansi-red-fg"> </span>circuit <span class="ansi-blue-fg">=</span> qml<span class="ansi-blue-fg">.</span>QNode<span class="ansi-blue-fg">(</span>model<span class="ansi-blue-fg">.</span>qcircuit<span class="ansi-blue-fg">,</span> dev<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     23</span> 
<span class="ansi-green-intense-fg ansi-bold">     24</span> circuit<span class="ansi-blue-fg">(</span>theta<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda3/envs/QC/lib/python3.7/site-packages/pennylane/qnodes/decorator.py</span> in <span class="ansi-cyan-fg">QNode</span><span class="ansi-blue-fg">(func, device, interface, mutable, diff_method, properties)</span>
<span class="ansi-green-intense-fg ansi-bold">    104</span>     <span class="ansi-green-fg">elif</span> model <span class="ansi-green-fg">in</span> PARAMETER_SHIFT_QNODES <span class="ansi-green-fg">and</span> diff_method <span class="ansi-green-fg">in</span> <span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;best&#34;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;parameter-shift&#34;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    105</span>         <span class="ansi-red-fg"># parameter-shift analytic differentiation</span>
<span class="ansi-green-fg">--&gt; 106</span><span class="ansi-red-fg">         </span>node <span class="ansi-blue-fg">=</span> PARAMETER_SHIFT_QNODES<span class="ansi-blue-fg">[</span>model<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">,</span> mutable<span class="ansi-blue-fg">=</span>mutable<span class="ansi-blue-fg">,</span> properties<span class="ansi-blue-fg">=</span>properties<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    107</span> 
<span class="ansi-green-intense-fg ansi-bold">    108</span>     <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda3/envs/QC/lib/python3.7/site-packages/pennylane/qnodes/jacobian.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, func, device, mutable, properties)</span>
<span class="ansi-green-intense-fg ansi-bold">     30</span> 
<span class="ansi-green-intense-fg ansi-bold">     31</span>     <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> func<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">,</span> mutable<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> properties<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 32</span><span class="ansi-red-fg">         </span>super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__init__<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">,</span> mutable<span class="ansi-blue-fg">=</span>mutable<span class="ansi-blue-fg">,</span> properties<span class="ansi-blue-fg">=</span>properties<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     33</span> 
<span class="ansi-green-intense-fg ansi-bold">     34</span>         self<span class="ansi-blue-fg">.</span>par_to_grad_method <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>

<span class="ansi-green-fg">~/anaconda3/envs/QC/lib/python3.7/site-packages/pennylane/qnodes/base.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, func, device, mutable, properties)</span>
<span class="ansi-green-intense-fg ansi-bold">    191</span> 
<span class="ansi-green-intense-fg ansi-bold">    192</span>         <span class="ansi-red-fg"># introspect the quantum function signature</span>
<span class="ansi-green-fg">--&gt; 193</span><span class="ansi-red-fg">         </span>_get_signature<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>func<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    194</span> 
<span class="ansi-green-intense-fg ansi-bold">    195</span>         self<span class="ansi-blue-fg">.</span>output_conversion <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>  <span class="ansi-red-fg">#: callable: for transforming the output of :meth:`.Device.execute` to QNode output</span>

<span class="ansi-green-fg">~/anaconda3/envs/QC/lib/python3.7/site-packages/pennylane/qnodes/base.py</span> in <span class="ansi-cyan-fg">_get_signature</span><span class="ansi-blue-fg">(func)</span>
<span class="ansi-green-intense-fg ansi-bold">     68</span>     <span class="ansi-red-fg"># count positional args, see if VAR_ args are present</span>
<span class="ansi-green-intense-fg ansi-bold">     69</span>     n_pos <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span>
<span class="ansi-green-fg">---&gt; 70</span><span class="ansi-red-fg">     </span>func<span class="ansi-blue-fg">.</span>var_pos <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>
<span class="ansi-green-intense-fg ansi-bold">     71</span>     func<span class="ansi-blue-fg">.</span>var_keyword <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>
<span class="ansi-green-intense-fg ansi-bold">     72</span>     <span class="ansi-green-fg">for</span> p <span class="ansi-green-fg">in</span> sig<span class="ansi-blue-fg">.</span>parameters<span class="ansi-blue-fg">.</span>values<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">AttributeError</span>: &#39;method&#39; object has no attribute &#39;var_pos&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">circuit</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-8-74d9d9b52b63&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>model<span class="ansi-blue-fg">.</span>Hessian<span class="ansi-blue-fg">(</span>theta<span class="ansi-blue-fg">,</span> circuit<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;circuit&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">init_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">width</span> <span class="o">*</span> <span class="n">layers</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">shots</span> <span class="o">=</span> <span class="mi">8192</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">width</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">layers</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">dev</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;default.qubit&#39;</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="n">shots</span><span class="p">)</span>

<span class="c1">#init_params = np.random.uniform(low=0.0, high=2 * np.pi, size=width * layers*3)</span>

<span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">width</span><span class="p">,))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">width</span><span class="p">))</span>
<span class="n">rho_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">target</span> <span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Setup_For_Training</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">rho_target</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">generate_gates</span><span class="p">()</span>

<span class="n">theta</span> <span class="o">=</span> <span class="n">init_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">circuit</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">QNode</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">qcircuit</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>

<span class="k">for</span> <span class="n">versuch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">init_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">width</span> <span class="o">*</span> <span class="n">layers</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">plot_lists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lr_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">GradientDescentOptimizer</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
        <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span>
        <span class="k">if</span> <span class="n">run</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;normal SGD&quot;</span><span class="p">)</span>
            <span class="n">get_hessian</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">get_metr_tens</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">run</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metric Tensor&quot;</span><span class="p">)</span>
            <span class="n">get_hessian</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">get_metr_tens</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">if</span> <span class="n">run</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hessian&quot;</span><span class="p">)</span>
            <span class="n">get_hessian</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">get_metr_tens</span><span class="o">=</span><span class="kc">False</span>

        <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">learning_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metric_tensor_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">init_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span> <span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">progress</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cost_fidelity</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">circuit</span><span class="p">)</span>
            <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">get_hessian</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">circuit</span><span class="p">)</span>
                <span class="n">Hev</span><span class="p">,</span> <span class="n">Hv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
                <span class="n">lr</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">Hev</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">GradientDescentOptimizer</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">cost_fidelity</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">circuit</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">get_metr_tens</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">tensor</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">circuit</span><span class="o">.</span><span class="n">metric_tensor</span><span class="p">([</span><span class="n">params</span><span class="p">],</span> <span class="n">diag_approx</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">lam</span><span class="o">=</span><span class="mf">0.00000001</span><span class="p">)</span>
                <span class="n">metric_tensor_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">cost_fidelity</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">circuit</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
            
            <span class="c1">#params = opt.step(lambda v: model.cost_fidelity(v, circuit), params)</span>
            <span class="c1">#opt.step(circuit, [params])</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span><span class="s1">&#39;loss: </span><span class="si">{:3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>
            <span class="n">learning_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
        <span class="n">plot_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_list</span><span class="p">)</span>
        <span class="n">lr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">learning_rates</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_list</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">plot</span> <span class="ow">in</span> <span class="n">plot_lists</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;Hessian_vs_QNG_versuch_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">versuch</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;Hessian_vs_QNG_versuch_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">versuch</span><span class="p">),</span> <span class="n">plot_lists</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;LR_Hessian_vs_QNG_versuch_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">versuch</span><span class="p">),</span> <span class="n">lr_list</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;Tensor_Hessian_vs_QNG_versuch_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">versuch</span><span class="p">),</span> <span class="n">metric_tensor_list</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AttributeError</span>                            Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-10-0baea9edeace&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     18</span> theta <span class="ansi-blue-fg">=</span> init_params<span class="ansi-blue-fg">.</span>copy<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     19</span> 
<span class="ansi-green-fg">---&gt; 20</span><span class="ansi-red-fg"> </span>circuit <span class="ansi-blue-fg">=</span> qml<span class="ansi-blue-fg">.</span>QNode<span class="ansi-blue-fg">(</span>model<span class="ansi-blue-fg">.</span>qcircuit<span class="ansi-blue-fg">,</span> dev<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     21</span> 
<span class="ansi-green-intense-fg ansi-bold">     22</span> <span class="ansi-green-fg">for</span> versuch <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">50</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda3/envs/QC/lib/python3.7/site-packages/pennylane/qnodes/decorator.py</span> in <span class="ansi-cyan-fg">QNode</span><span class="ansi-blue-fg">(func, device, interface, mutable, diff_method, properties)</span>
<span class="ansi-green-intense-fg ansi-bold">    104</span>     <span class="ansi-green-fg">elif</span> model <span class="ansi-green-fg">in</span> PARAMETER_SHIFT_QNODES <span class="ansi-green-fg">and</span> diff_method <span class="ansi-green-fg">in</span> <span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;best&#34;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;parameter-shift&#34;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    105</span>         <span class="ansi-red-fg"># parameter-shift analytic differentiation</span>
<span class="ansi-green-fg">--&gt; 106</span><span class="ansi-red-fg">         </span>node <span class="ansi-blue-fg">=</span> PARAMETER_SHIFT_QNODES<span class="ansi-blue-fg">[</span>model<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">,</span> mutable<span class="ansi-blue-fg">=</span>mutable<span class="ansi-blue-fg">,</span> properties<span class="ansi-blue-fg">=</span>properties<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    107</span> 
<span class="ansi-green-intense-fg ansi-bold">    108</span>     <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda3/envs/QC/lib/python3.7/site-packages/pennylane/qnodes/jacobian.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, func, device, mutable, properties)</span>
<span class="ansi-green-intense-fg ansi-bold">     30</span> 
<span class="ansi-green-intense-fg ansi-bold">     31</span>     <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> func<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">,</span> mutable<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> properties<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 32</span><span class="ansi-red-fg">         </span>super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__init__<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">,</span> mutable<span class="ansi-blue-fg">=</span>mutable<span class="ansi-blue-fg">,</span> properties<span class="ansi-blue-fg">=</span>properties<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     33</span> 
<span class="ansi-green-intense-fg ansi-bold">     34</span>         self<span class="ansi-blue-fg">.</span>par_to_grad_method <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>

<span class="ansi-green-fg">~/anaconda3/envs/QC/lib/python3.7/site-packages/pennylane/qnodes/base.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, func, device, mutable, properties)</span>
<span class="ansi-green-intense-fg ansi-bold">    191</span> 
<span class="ansi-green-intense-fg ansi-bold">    192</span>         <span class="ansi-red-fg"># introspect the quantum function signature</span>
<span class="ansi-green-fg">--&gt; 193</span><span class="ansi-red-fg">         </span>_get_signature<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>func<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    194</span> 
<span class="ansi-green-intense-fg ansi-bold">    195</span>         self<span class="ansi-blue-fg">.</span>output_conversion <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>  <span class="ansi-red-fg">#: callable: for transforming the output of :meth:`.Device.execute` to QNode output</span>

<span class="ansi-green-fg">~/anaconda3/envs/QC/lib/python3.7/site-packages/pennylane/qnodes/base.py</span> in <span class="ansi-cyan-fg">_get_signature</span><span class="ansi-blue-fg">(func)</span>
<span class="ansi-green-intense-fg ansi-bold">     68</span>     <span class="ansi-red-fg"># count positional args, see if VAR_ args are present</span>
<span class="ansi-green-intense-fg ansi-bold">     69</span>     n_pos <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span>
<span class="ansi-green-fg">---&gt; 70</span><span class="ansi-red-fg">     </span>func<span class="ansi-blue-fg">.</span>var_pos <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>
<span class="ansi-green-intense-fg ansi-bold">     71</span>     func<span class="ansi-blue-fg">.</span>var_keyword <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>
<span class="ansi-green-intense-fg ansi-bold">     72</span>     <span class="ansi-green-fg">for</span> p <span class="ansi-green-fg">in</span> sig<span class="ansi-blue-fg">.</span>parameters<span class="ansi-blue-fg">.</span>values<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">AttributeError</span>: &#39;method&#39; object has no attribute &#39;var_pos&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plot_lists</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[[0.567185710103868,
  0.5621786612039066,
  0.5575144626167986,
  0.5531756439286589,
  0.5491445495045013,
  0.545403568634112,
  0.5419353258476998,
  0.5387228347861929,
  0.5357496193606555,
  0.5329998060572283,
  0.5304581911944993,
  0.5281102867683669,
  0.5259423482661155,
  0.5239413875296082,
  0.5220951734226524,
  0.5203922227287504,
  0.5188217833860923,
  0.5173738118658723,
  0.5160389462233206,
  0.5148084761011917,
  0.5136743107437057,
  0.5126289458847177,
  0.511665430205792,
  0.5107773319159545,
  0.5099587058829561,
  0.5092040616435448,
  0.5085083325351432,
  0.5078668461212769,
  0.5072752960259432,
  0.5067297152460243,
  0.5062264509740748,
  0.5057621409349143,
  0.5053336912170479,
  0.5049382555629802,
  0.5045732160699253,
  0.5042361652434925,
  0.5039248893409073,
  0.5036373529366414,
  0.5033716846414852,
  0.5031261639057087,
  0.5028992088376667,
  0.502689364970758,
  0.502495294913831,
  0.5023157688227284,
  0.5021496556335883,
  0.5019959150015929,
  0.5018535898920562,
  0.5017217997739359,
  0.5015997343690458,
  0.501486647913328,
  0.5013818538895746,
  0.5012847201938548,
  0.5011946647006599,
  0.5011111511943752,
  0.5010336856371604,
  0.5009618127456044,
  0.5008951128507033,
  0.5008331990177048,
  0.5007757144042535,
  0.5007223298369984,
  0.5006727415884513,
  0.5006266693373671,
  0.5005838542972959,
  0.500544057499235,
  0.5005070582154758,
  0.5004726525128115,
  0.5004406519242832,
  0.500410882229526,
  0.5003831823346334,
  0.5003574032432136,
  0.5003334071110226,
  0.5003110663771937,
  0.5002902629656852,
  0.5002708875510973,
  0.500252838883513,
  0.5002360231674636,
  0.5002203534905452,
  0.5002057492975728,
  0.5001921359065283,
  0.5001794440628582,
  0.5001676095289741,
  0.5001565727060777,
  0.5001462782856647,
  0.5001366749282962,
  0.5001277149674176,
  0.5001193541362003,
  0.500111551315542,
  0.5001042683015258,
  0.5000974695907727,
  0.5000911221822545,
  0.5000851953942558,
  0.5000796606952793,
  0.5000744915477833,
  0.5000696632637451,
  0.5000651528711137,
  0.5000609389902944,
  0.5000570017198845,
  0.5000533225309374,
  0.5000498841690874,
  0.5000466705639335],
 [0.567185710103868,
  0.5457719808201411,
  0.5305842204067214,
  0.5201548599623393,
  0.5131551907348887,
  0.5085307906227043,
  0.5055079385165039,
  0.5035459287416003,
  0.5022784293726579,
  0.5014621316338272,
  0.5009374928226346,
  0.500600761556122,
  0.5003848306492821,
  0.5002464472219813,
  0.5001577976442115,
  0.5001010236941149,
  0.5000646707959668,
  0.5000413967609101,
  0.500026497521624,
  0.5000169601676197,
  0.5000108553720735,
  0.500006947868851,
  0.5000044468526355,
  0.5000028460955744,
  0.5000018215574229,
  0.500001165825807,
  0.5000007461436614,
  0.5000004775399128,
  0.5000003056297797,
  0.5000001956053342,
  0.5000001251886501,
  0.5000000801214156,
  0.5000000512780847,
  0.5000000328181877,
  0.5000000210037623,
  0.5000000134424785,
  0.5000000086032276,
  0.5000000055060901,
  0.5000000035239126,
  0.5000000022553128,
  0.500000001443406,
  0.500000000923783,
  0.5000000005912232,
  0.5000000003783843,
  0.5000000002421667,
  0.5000000001549871,
  0.5000000000991923,
  0.5000000000634832,
  0.5000000000406292,
  0.5000000000260029,
  0.500000000016642,
  0.5000000000106508,
  0.5000000000068165,
  0.5000000000043627,
  0.5000000000027921,
  0.500000000001787,
  0.5000000000011436,
  0.5000000000007319,
  0.5000000000004686,
  0.5000000000003,
  0.500000000000192,
  0.5000000000001227,
  0.5000000000000787,
  0.5000000000000504,
  0.5000000000000323,
  0.5000000000000205,
  0.5000000000000133,
  0.5000000000000085,
  0.5000000000000053,
  0.5000000000000036,
  0.500000000000002,
  0.5000000000000014,
  0.5000000000000009,
  0.5000000000000008,
  0.5000000000000002,
  0.5000000000000004,
  0.5000000000000001,
  0.5000000000000002,
  0.5000000000000001,
  0.4999999999999999,
  0.5000000000000001,
  0.4999999999999999,
  0.5000000000000001,
  0.5,
  0.5000000000000001,
  0.4999999999999998,
  0.5000000000000001,
  0.5,
  0.5,
  0.4999999999999999,
  0.4999999999999999,
  0.4999999999999999,
  0.5,
  0.5000000000000001,
  0.5000000000000001,
  0.5,
  0.4999999999999999,
  0.5,
  0.5,
  0.4999999999999999]]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">circuit</span><span class="o">.</span><span class="n">metric_tensor</span><span class="p">([</span><span class="n">params</span><span class="p">],</span> <span class="n">diag_approx</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[0.        , 0.        , 0.        , ..., 0.        , 0.        ,
        0.        ],
       [0.        , 0.25      , 0.        , ..., 0.        , 0.        ,
        0.        ],
       [0.        , 0.        , 0.00110482, ..., 0.        , 0.        ,
        0.        ],
       ...,
       [0.        , 0.        , 0.        , ..., 0.00831934, 0.        ,
        0.        ],
       [0.        , 0.        , 0.        , ..., 0.        , 0.25      ,
        0.        ],
       [0.        , 0.        , 0.        , ..., 0.        , 0.        ,
        0.01469551]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">compute_grad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">cost_fidelity</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">circuit</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
<span class="n">step</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">circuit</span><span class="o">.</span><span class="n">metric_tensor</span><span class="p">([</span><span class="n">params</span><span class="p">],</span> <span class="n">diag_approx</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">lam</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([ 6.07153217e-18, -1.55814155e-02, -5.68941218e-07, -5.68941218e-07,
       -1.71443908e-02, -1.15617667e-06, -1.15617665e-06, -2.01438497e-02,
       -1.80194490e-06, -1.80194785e-06, -1.46170187e-02, -2.11664171e-06,
        7.80625564e-18, -1.56650645e-02, -3.35792373e-07, -3.35792424e-07,
       -1.72366182e-02, -6.90098543e-07, -6.90098950e-07, -2.02298312e-02,
       -1.03348007e-06, -1.03348287e-06, -1.48082902e-02, -1.12898204e-06,
       -0.00000000e+00, -1.51959257e-02, -2.06149046e-07, -2.06149046e-07,
       -1.66113487e-02, -4.94937020e-07, -4.94937413e-07, -1.98911493e-02,
       -8.44781920e-07, -8.44783254e-07, -1.48082902e-02, -9.09713466e-07,
        1.95854130e-24, -1.49121201e-02, -1.38449474e-06, -1.38449476e-06,
       -1.63637761e-02, -2.56990121e-06, -2.56990142e-06, -1.96855683e-02,
       -3.49507792e-06, -3.49507768e-06, -1.46170185e-02, -3.82200840e-06])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

